{"version":3,"file":"spawn-server.js","names":["randomString","PROMISE_RESOLVE_VOID","getFetchWithCouchDBAuthorization","ENV_VARIABLES","spawn","databaseName","port","NATIVE_COUCHDB","Error","parseInt","url","controller","AbortController","setTimeout","abort","authFetch","method","signal","dbName","close"],"sources":["../../test/helper/spawn-server.ts"],"sourcesContent":["import { randomString } from 'async-test-util';\r\nimport { PROMISE_RESOLVE_VOID } from '../../plugins/core/index.mjs';\r\nimport { getFetchWithCouchDBAuthorization } from '../../plugins/replication-couchdb/index.mjs';\r\nimport {\r\n    ENV_VARIABLES\r\n} from '../../plugins/test-utils/index.mjs';\r\n\r\n/**\r\n * Spawns a CouchDB server\r\n */\r\nexport async function spawn(\r\n    databaseName = randomString(5),\r\n    port?: number\r\n): Promise<{\r\n    dbName: string;\r\n    url: string;\r\n    close: () => Promise<void>;\r\n}> {\r\n    if (!ENV_VARIABLES.NATIVE_COUCHDB) {\r\n        throw new Error('ENV_VARIABLES.NATIVE_COUCHDB not set. A CouchDB server must be started');\r\n    }\r\n\r\n    if (port) {\r\n        throw new Error('if NATIVE_COUCHDB is set, do not specify a port');\r\n    }\r\n    port = parseInt(ENV_VARIABLES.NATIVE_COUCHDB, 10);\r\n    const url = 'http://0.0.0.0:' + port + '/' + databaseName + '/';\r\n\r\n    const controller = new AbortController();\r\n    setTimeout(() => controller.abort(), 1000);\r\n    const authFetch = getFetchWithCouchDBAuthorization('root', 'root');\r\n    await authFetch(\r\n        url,\r\n        {\r\n            method: 'PUT',\r\n            signal: controller.signal\r\n        }\r\n    );\r\n    return {\r\n        dbName: databaseName,\r\n        url,\r\n        close: () => PROMISE_RESOLVE_VOID\r\n    };\r\n}\r\n"],"mappings":"AAAA,SAASA,YAAY,QAAQ,iBAAiB;AAC9C,SAASC,oBAAoB,QAAQ,8BAA8B;AACnE,SAASC,gCAAgC,QAAQ,6CAA6C;AAC9F,SACIC,aAAa,QACV,oCAAoC;;AAE3C;AACA;AACA;AACA,OAAO,eAAeC,KAAKA,CACvBC,YAAY,GAAGL,YAAY,CAAC,CAAC,CAAC,EAC9BM,IAAa,EAKd;EACC,IAAI,CAACH,aAAa,CAACI,cAAc,EAAE;IAC/B,MAAM,IAAIC,KAAK,CAAC,wEAAwE,CAAC;EAC7F;EAEA,IAAIF,IAAI,EAAE;IACN,MAAM,IAAIE,KAAK,CAAC,iDAAiD,CAAC;EACtE;EACAF,IAAI,GAAGG,QAAQ,CAACN,aAAa,CAACI,cAAc,EAAE,EAAE,CAAC;EACjD,IAAMG,GAAG,GAAG,iBAAiB,GAAGJ,IAAI,GAAG,GAAG,GAAGD,YAAY,GAAG,GAAG;EAE/D,IAAMM,UAAU,GAAG,IAAIC,eAAe,CAAC,CAAC;EACxCC,UAAU,CAAC,MAAMF,UAAU,CAACG,KAAK,CAAC,CAAC,EAAE,IAAI,CAAC;EAC1C,IAAMC,SAAS,GAAGb,gCAAgC,CAAC,MAAM,EAAE,MAAM,CAAC;EAClE,MAAMa,SAAS,CACXL,GAAG,EACH;IACIM,MAAM,EAAE,KAAK;IACbC,MAAM,EAAEN,UAAU,CAACM;EACvB,CACJ,CAAC;EACD,OAAO;IACHC,MAAM,EAAEb,YAAY;IACpBK,GAAG;IACHS,KAAK,EAAEA,CAAA,KAAMlB;EACjB,CAAC;AACL"}